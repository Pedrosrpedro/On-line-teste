<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão P2P na Tela</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; }
        .container { width: auto; margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2, h3 { text-align: center; color: #333; margin-top: 0; }
        textarea { width: calc(100% - 22px); min-height: 90px; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; -webkit-appearance: none; }
        button { width: 100%; padding: 14px; margin-bottom: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; }
        button:disabled { background-color: #999; }
        .console { background-color: #222; color: #0f0; border: 1px solid #444; height: 150px; overflow-y: scroll; padding: 10px; font-size: 0.9em; font-family: 'Courier New', Courier, monospace; border-radius: 4px; margin-top: 15px; }
        .hidden { display: none; }
        .section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
        input[type="text"] { width: calc(100% - 24px); padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        p { color: #555; text-align: center; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Você é o SERVIDOR?</h2>
        <button id="startServerBtn">Sim, Criar Partida</button>
    </div>

    <div class="container">
        <h2>Você é o CLIENTE?</h2>
        <button id="startClientBtn">Sim, Entrar na Partida</button>
    </div>

    <!-- SEÇÃO DO JOGO (COMEÇA ESCONDIDA) -->
    <div id="game-section" class="container hidden">
        <h2 id="role-title"></h2> <!-- Título: Servidor ou Cliente -->

        <!-- PASSO 1: Oferta/Resposta -->
        <div id="step1-server" class="section hidden">
            <h3>PASSO 1: Envie sua "Oferta"</h3>
            <p>Copie o texto abaixo e envie para o Cliente.</p>
            <textarea id="offer-text" readonly></textarea>
        </div>
        <div id="step1-client" class="section hidden">
            <h3>PASSO 1: Cole a "Oferta" do Servidor</h3>
            <textarea id="offer-input" placeholder="Cole a Oferta aqui..."></textarea>
            <button id="generate-answer-btn">Gerar Minha Resposta</button>
        </div>

        <!-- PASSO 2: Resposta -->
        <div id="step2-server" class="section hidden">
            <h3>PASSO 2: Cole a "Resposta" do Cliente</h3>
            <textarea id="answer-input" placeholder="Cole a Resposta aqui..."></textarea>
            <button id="confirm-answer-btn">Confirmar Resposta</button>
        </div>
        <div id="step2-client" class="section hidden">
            <h3>PASSO 2: Envie sua "Resposta"</h3>
            <p>Copie o texto abaixo e envie de volta para o Servidor.</p>
            <textarea id="answer-text" readonly></textarea>
        </div>

        <!-- PASSO 3: Troca de Candidates -->
        <div id="step3-ice-exchange" class="section hidden">
            <h3>PASSO 3: Troca de "Candidates"</h3>
            <p>Este passo pode se repetir. Continue trocando os candidates até a conexão ser estabelecida.</p>
            
            <h4>Seus Candidates Gerados</h4>
            <p>Copie o que aparecer aqui e envie para o outro jogador.</p>
            <textarea id="my-candidates" readonly></textarea>

            <h4>Candidates Recebidos</h4>
            <p>Cole os candidates que você recebeu do outro jogador aqui.</p>
            <textarea id="received-candidates" placeholder="Cole um candidate recebido aqui..."></textarea>
            <button id="add-candidate-btn">Adicionar Candidate</button>
        </div>

        <!-- PASSO 4: Comunicação -->
        <div id="step4-communication" class="section hidden">
            <h3>PASSO 4: CONECTADO!</h3>
            <input type="text" id="message-input" placeholder="Digite sua mensagem">
            <button id="send-message-btn">Enviar</button>
        </div>

        <div class="console" id="log-console"><b>Console de Eventos:</b><br></div>
    </div>


    <script>
        let peerConnection;
        let dataChannel;
        let myRole = '';

        // --- Elementos do DOM ---
        const startServerBtn = document.getElementById('startServerBtn');
        const startClientBtn = document.getElementById('startClientBtn');
        const gameSection = document.getElementById('game-section');
        const roleTitle = document.getElementById('role-title');
        const logConsole = document.getElementById('log-console');

        // Seções dos Passos
        const serverStep1 = document.getElementById('step1-server');
        const clientStep1 = document.getElementById('step1-client');
        const serverStep2 = document.getElementById('step2-server');
        const clientStep2 = document.getElementById('step2-client');
        const step3 = document.getElementById('step3-ice-exchange');
        const step4 = document.getElementById('step4-communication');

        // Campos de texto e botões
        const offerText = document.getElementById('offer-text');
        const offerInput = document.getElementById('offer-input');
        const generateAnswerBtn = document.getElementById('generate-answer-btn');
        const answerText = document.getElementById('answer-text');
        const answerInput = document.getElementById('answer-input');
        const confirmAnswerBtn = document.getElementById('confirm-answer-btn');
        const myCandidates = document.getElementById('my-candidates');
        const receivedCandidates = document.getElementById('received-candidates');
        const addCandidateBtn = document.getElementById('add-candidate-btn');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // --- Funções de Lógica ---

        function log(message) {
            logConsole.innerHTML += `> ${message}<br>`;
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function initialize(role) {
            myRole = role;
            startServerBtn.parentElement.classList.add('hidden');
            startClientBtn.parentElement.classList.add('hidden');
            gameSection.classList.remove('hidden');
            
            roleTitle.innerText = `Você é o: ${role.toUpperCase()}`;
            log(`Modo ${role} iniciado. Siga os passos.`);

            peerConnection = new RTCPeerConnection(null);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    log('Novo candidate gerado! Copie-o da caixa "Seus Candidates Gerados" e envie.');
                    myCandidates.value += JSON.stringify(event.candidate) + '\n\n';
                }
            };

            peerConnection.onconnectionstatechange = () => {
                log(`Estado da conexão: ${peerConnection.connectionState}`);
                if (peerConnection.connectionState === 'connected') {
                    step3.classList.add('hidden');
                    step4.classList.remove('hidden');
                    log('CONEXÃO BEM-SUCEDIDA!');
                }
            };
            
            if (role === 'servidor') {
                serverStep1.classList.remove('hidden');
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
                createOffer();
            } else { // Cliente
                clientStep1.classList.remove('hidden');
                peerConnection.ondatachannel = event => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
        }
        
        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                offerText.value = JSON.stringify(peerConnection.localDescription);
                log('Oferta criada. Copie e envie ao cliente.');
                serverStep2.classList.remove('hidden');
            } catch (e) {
                log(`Erro ao criar oferta: ${e}`);
            }
        }
        
        async function createAnswer() {
            try {
                const offer = JSON.parse(offerInput.value);
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                answerText.value = JSON.stringify(peerConnection.localDescription);
                log('Resposta criada. Copie e envie ao servidor.');
                
                generateAnswerBtn.disabled = true;
                clientStep2.classList.remove('hidden');
                step3.classList.remove('hidden');
            } catch (e) {
                log(`Erro ao criar resposta: ${e}. Verifique se a oferta foi colada corretamente.`);
            }
        }
        
        async function acceptAnswer() {
            try {
                const answer = JSON.parse(answerInput.value);
                await peerConnection.setRemoteDescription(answer);
                log('Resposta do cliente aceita.');
                confirmAnswerBtn.disabled = true;
                step3.classList.remove('hidden');
            } catch(e) {
                log(`Erro ao aceitar resposta: ${e}. Verifique se a resposta foi colada corretamente.`);
            }
        }

        function addCandidate() {
            try {
                const candidate = JSON.parse(receivedCandidates.value);
                peerConnection.addIceCandidate(candidate);
                log('Candidate recebido adicionado com sucesso.');
                receivedCandidates.value = '';
            } catch(e) {
                log(`Erro ao adicionar candidate: ${e}. Verifique o texto colado.`);
            }
        }
        
        function setupDataChannel() {
            dataChannel.onopen = () => log('CANAL DE DADOS ABERTO! Vocês podem conversar.');
            dataChannel.onclose = () => log('Canal de dados fechado.');
            dataChannel.onmessage = event => {
                const originator = myRole === 'servidor' ? 'Cliente' : 'Servidor';
                log(`${originator} diz: ${event.data}`);
            };
        }
        
        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() === '') return;
            dataChannel.send(message);
            log(`Você: ${message}`);
            messageInput.value = '';
        }

        // --- Event Listeners ---
        startServerBtn.onclick = () => initialize('servidor');
        startClientBtn.onclick = () => initialize('cliente');
        generateAnswerBtn.onclick = createAnswer;
        confirmAnswerBtn.onclick = acceptAnswer;
        addCandidateBtn.onclick = addCandidate;
        sendMessageBtn.onclick = sendMessage;
    </script>
</body>
</html>
